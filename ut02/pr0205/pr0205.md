# üìÑ PR0205: Programaci√≥n de tareas con `cron`

## ‚úÖ Objetivos
- Explorar las diferentes posibilidades de `cron` para crear tareas programadas en un entorno Linux.

## üîé Recursos
- [Crontab.guru](https://crontab.guru/)

### üìå 1. ¬øQu√© orden pondr√≠as en crontab en los siguientes casos?
Para programar tareas con `cron`, tenemos que editar un archivo que se ejecuta con `crontab -e`, escogemos la opci√≥n de con qu√© editor queremos editar el archivo y ah√≠ podemos programar las tareas.

- La tarea se ejecuta cada hora  
```
0 * * * * "comando"
```

- La tarea se ejecuta los domingos cada 3 horas  
```
0 */3 * * 0 "comando"
```

- La tarea se ejecuta a las 12 de la ma√±ana los d√≠as pares del mes.  
```
0 12 2/2 * * "comando"
```

- La tarea se ejecuta el primer d√≠a de cada mes a las 8 de la ma√±ana y a las 8 de la tarde  
```
0 8,20 1 * * "comando"
```

- La tarea se ejecuta cada media hora de lunes a viernes  
```
*/30 * * * 1-5 "comando"
```

- La tarea se ejecuta cada cuarto de hora, entre las 3 y las 8, de lunes a viernes, durante todo el mes de agosto  
```
*/15 3-8 * 8 1-5 "comando"
```

- La tarea se ejecuta cada 90 minutos

No se puede ejecutar en una sola l√≠nea porque supera los 59 minutos l√≠mites. Para ello habr√≠a que hacerlo en dos l√≠neas diferentes para ejecutarlo. Ser√≠an las siguientes:
```
0 */3 * * * comando
*/30 1-23/3 * * * comando
```

### üìå 2. ¬øC√≥mo compruebas si el servicio cron se est√° ejecutando?
Ponemos `sudo systemctl status cron`. Si en **Active:** se encuentra de color verde, se est√° ejecutando, pero si est√° en rojo, eso significa que el servicio est√° parado.

![Status cron](Imagenes/2-cron.png)

### üìå 3. ¬øCu√°l es el efecto de la siguiente l√≠nea crontab?
```
*/15 1,2,3 * * * who > /tmp/test
```

Esta programaci√≥n indica que se va a ejecutar a las 1:15, 2:15 y 3:15 de todos los d√≠as, todos los d√≠as del mes y todos los d√≠as de la semana el comando `who` que muestra cu√°les usuarios est√°n conectados en ese momento en el sistema y esa muestra, se redirecciona a la ruta `/tmp/test` y como est√° con el signo **>**, sobreescribe lo anteriormente escrito.

### üìå 4. Indica la ruta del fichero crontab del sistema
La ruta del fichero de crontab es `/etc/crontab`.

Existe tambi√©n otro fichero para cada usuario que se encuentra en `/var/spool/cron/crontabs/`. Pero lo recomendable es editar desde `crontab -e`.

### üìå 5. ¬øQu√© ficheros controlan los usuarios que pueden utilizar el `crontab`?
Los archivos que controlan el acceso son:
- `/etc/cron.allow`: Sirve para controlar a los usuarios autorizados a usar cron.

- `/etc/cron.deny`: Sirve para controlar a los usuarios no autorizados a usar cron.

No hace falta tener los dos archivos a la vez. Si ya tenemos solamente el archivo **cron.allow** por defecto, de manera autom√°tica aquel usuario que no est√© en esa lista, no tiene permitido editar. Si tenemos solo el archivo **cron.deny** pasar√≠a lo mismo pero del rev√©s.

### üìå 6. Excepcionalmente se debe iniciar una tarea llamada `script.sh` todos los lunes a las 07:30h antes de entrar en clase ¬øC√≥mo lo har√≠as?
Ponemos `crontab -e` para abrir el men√∫ de escoger el editor, en mi caso, escogo nano **(1)** porque es m√°s sencillo y r√°pido.

Hacemos la programaci√≥n que indica el ejercicio que es el siguiente junto a la ruta donde queramos que se ejecute y el archivo, que en este caso es **script.sh**:

```
30 7 * * 1 /home/hector/script.sh
```

![crontab](Imagenes/6-crontab.png)

> üí¨ Las l√≠neas que empiezan con **#**, son l√≠neas comentadas y esas no se van a ejecutar.  
No se ejecutar√≠a nada porque script.sh est√° vac√≠o.  
Tampoco podemos verlo con `ls` porque no tenemos el archivo creado.


### üìå 7. Se ha cancelado la tarea. ¬øC√≥mo listar y luego, suprimir la tarea?
Para listar las tareas ponemos `crontab -l`. Esto nos muestra las tareas que est√°n activas en ese momento.

![crontab -l](Imagenes/7-crontab.png)

Para borrar las tareas, podemos editar el archivo con `crontab -e` o directamente con `crontab -r`, pero este √∫ltimo borra **TODAS** las tareas.

### üìå 8. Ejecuta el comando `ps -ef` para el usuario **root** cada 2 minutos y redirecciona el resultado a `/tmp/ps_result` sin sobrescribir los antiguos.
Para crear una tarea programada para **root**, ser√≠a ejecutar `crontab -e` pero con `sudo` al principio, es decir, `sudo crontab -e`.

La l√≠nea que se a√±ade para la tarea es:

```
*/2 * * * * ps -ef >> /tmp/ps_result
```

![Tarea con sudo](Imagenes/8-sudoCrontab.png)

### üìå 9. Verifica la lista de tareas en `crontab`
Para ver la lista de tareas, ponemos `crontab -l`, pero como va a ser para **root**, pondremos `sudo crontab -l`.

Hay otra manera, que es por filtrado de usuario y para ello ponemos `crontab -l root` para **root** y `crontab -l "usuario"` para el usuario que queramos. Al poner el modificador `-u`, pedir√° privilegios, con lo que pondremos `sudo` al principio del comando.

### üìå 10. Espera unos minutos y comprueba el resultado en `/tmp`
Si ponemos `ls /tmp` vemos que el fichero ps_result existe y con diferente color.

![ls /tmp](Imagenes/10-ls.png)

Ahora ponemos `cat /tmp/ps_result` y podemos ver lo siguiente:

![cat /tmp/ps_result](Imagenes/10-cat.png)

### üìå 11. Crea el usuario asir2 y proh√≠bele utilizar el crontab
Creamos el usuario **asir2** con `sudo adduser asir2`.

Vamos a editar el archivo **cron.deny** con `sudo nano /etc/cron.deny` y ah√≠ a√±adimos al usuario **asir2**.

![Denegar asir2](Imagenes/11-denegar.png)

### üìå 12. Verifica que el usuario **asir2** realmente no puede utilizar `crontab`.
Para verificar que **asir2** no puede usar `crontab`, iniciamos sesion con `su asir2` y ponemos `crontab -e`.

![No usar crontab](Imagenes/12-NOcrontab.png)

### üìå 13. Programa `crontab` para que cada d√≠a a las 0:05 se eliminen todos los ficheros que se encuentran en el directorio `/tmp`
Para poner la tarea, pondremos la siguiente l√≠nea y la ponemos en `crontab -e`.

```
5 0 * * * rm -rf /tmp/*
```

Como `tmp` requiere de privilegios, lo haremos con `sudo crontab -e`.

![Borrar archivos tmp](Imagenes/13-sudoCrontab.png)

### üìå 14. Programa una tarea en el sistema que se lance de lunes a viernes a las 9 de la ma√±ana durante los meses de verano (julio, agosto y septiembre) que escriba en un fichero la hora actual (comando `date`) seguido del listado de usuarios que hay conectados en ese momento en el sistema (comando `who`)
La tarea que pide el ejercicio y que tenga algo de sentido es √©sta:
```
0 9 * 7-9 1-5 date +"%H:%M:%S"; who
```

Para ver la informaci√≥n que se le pide, habr√≠a que ponerle a mayores un redireccionamiento hacia un archivo que queramos. Por ejemplo, **UsuariosConectados**.

Al final quedar√≠a de √©sta manera:
```
0 9 * 7-9 1-5 date +"%H:%M:%S"; who >> /home/hector/UsuariosConectados
```

### üìå 15. El servicio `cron` se ayuda de una serie de ficheros y directorios que se encuentran en el directorio `/etc`. Explica la funci√≥n de cada uno de los siguientes ficheros/directorios:
- **cron.d:** Contiene los archivos de configuraci√≥n adicionales de las tareas de `cron`.

- **cron.allow:** Permite utilizar crontab a los usuarios que pertenezcan a la lista.

- **cron.deny:** No permite utilizar crontab a los usuarios que pertenezcan a la lista.

- **cron.dialy:** Contiene los scripts que se ejecutan una vez al d√≠a de manera autom√°tica.

- **cron.hourly:** Contiene los scripts que se ejecutan una vez cada hora de manera autom√°tica.

- **cron.monthy:** Contiene los scripts que se ejecutan una vez al mes de manera autom√°tica, normalmente el primer d√≠a del mes.

---
### [‚¨ÖÔ∏è Volver a UT02](../index.md)
---