# üìÑ PR0203: Conexi√≥n remota con SSH entre redes

## ‚úÖ Objetivos
- Conectarse por **SSH** de manera transparente desde la m√°quina anfitriona hacia el **SERVER-A** con la cuenta de usuario creada.

- Conectarse por **SSH** de manera transparente desde la m√°quina **SERVER-A** hacia **SERVER-B** y **SERVER-C** con la cuenta de **sysadmin**.

## üì¶ Creaci√≥n de las m√°quinas
Creamos tres m√°quinas virtuales en **VirtualBox** de **Ubuntu Server 25.04** que ser√°n las siguientes:

|                | SERVER-A   | SERVER-B   | SERVER-C   |
|:--------------:|:----------:|:----------:|:----------:|
| **Usuario**    | hector     | sysadmin   | sysadmin   |
| **Hostname**   | server-a   | server-b   | server-c   |

En la instalaci√≥n, va a salir una ventana en si queremos instalar el servidor **SSH**, lo marcamos con **espacio** y despu√©s a **Hecho**.

![Instalar SSH](Imagenes/SSH.png)

Al **SERVER-A**, le ponemos **4** adaptadores de red, el primero en **NAT** y los dem√°s en **Adaptador solo anfitri√≥n**.

![Adaptador red SERVER-A](Imagenes/Red-A.png)

Las otras dos m√°quinas vamos a ponerles el primer adaptador en **NAT** y el secundario en **Adaptador solo anfitri√≥n**.

![Adaptador red SERVER-B y C](Imagenes/Red-BC.png)

Antes de todo, se pondr√° en una tabla las direcciones **IP** y el adaptador de red que deber√≠an de tener las m√°quinas.

| Adaptador | SERVER-A         | SERVER-B      | SERVER-C      |
|:---------:|:----------------:|:-------------:|:-------------:|
| enp0s3    | NAT              | NAT           | NAT           |
| enp0s8    | 192.168.56.10/24 | 10.20.0.20/16 | 10.30.0.20/16 |
| enp0s9    | 10.20.0.10/16    | √ò             | √ò             |
| enp0s10   | 10.30.0.10/16    | √ò             | √ò             |

## üîß Configurar la red de **SERVER-A**

Dentro de SERVER-A, vamos a poner `ip a` para ver nuestros adaptadores de red y ver el nombre de adaptador para poder editarlos.

![ip a SERVER-A](Imagenes/ipa-A.png)

Vemos que solo el adaptador con el nombre **enp0s3** tiene IP y los dem√°s no, esto es por lo que hicimos antes.

Para las dem√°s m√°quinas, tendr√≠amos lo mismo pero con solo 2 adaptadores.

Para editar la red para que los adaptadores tengan IP, tenemos que editar el archivo `sudo nano /etc/netplan/50-cloud-init.yaml`. Esto, hay que hacerlo en las tres m√°quinas.

En principio, tendr√≠amos el archivo as√≠:

![Editar redes](Imagenes/netplan.png)

Para editarlo, tenemos que poner debajo del adaptador que ya tiene **IP**, por el que vamos a configurar, en este caso, ser√° el **enp0s8** y deber√≠a de quedarnos de √©sta manera:

![netplan A](Imagenes/netplan-A.png)

Ahora guardamos los cambios con `sudo netplan apply` y volvemos a poner `ip a`, veremos que el adaptador que hemos configurado ya tiene la IP de manera est√°tica.

![ip a SERVER-A](Imagenes/ipa1.png)

Para comprobar que todo haya funcionado, nos conectaremos por **SSH** desde nuestra m√°quina anfitriona al **SERVER-A**.

![SSH SERVER-A](Imagenes/ssh_A_1.png)

Ahora desde la terminal de nuestra m√°quina anfitriona configuramos las dem√°s **IPs** para las dem√°s m√°quinas. Volvemos a poner `sudo nano /etc/netplan/50-cloud-init.yaml` y pondremos las **IPs** que faltan en los adaptadores. Deber√≠a de quedar de √©sta manera:

![Netplan A completo](Imagenes/netplan-A_1.png)

Volvemos a guardar los cambios con `sudo netplan apply` y ponemos `ip a` para ver los cambios guardados.

![ip a completo](Imagenes/ipa-A-completo.png)

Ahora ya tenemos la red configurada para **SERVER-A**.

Ahora configuramos los adaptadores de las dem√°s m√°quinas.

## üîß Configurar la red de **SERVER-B** y **SERVER-C**

Para configurar la red, va a ser lo mismo tanto para **SERVER-B** como **SERVER-C**. Como solamente tenemos un adaptador para configurar, vamos a tener que seguir los mismos pasos que hicimos en **SERVER-A**.

### üì¶ SERVER-B

Ponemos `sudo nano /etc/netplan/50-cloud-init.yaml` y ponemos el adaptador y la **IP** de la tabla que viene m√°s arriba anotada.

![ip a SERVER-B](Imagenes/netplan-B.png)

Guardamos con `sudo netplan apply` y comprobamos con `ip a`.

![ip a SERVER-B](Imagenes/ipa-B.png)

Ahora con la red configurada de **SERVER-B**, vamos a hacer `ping 10.20.0.10` que es el adaptador por el que est√° conectado **SERVER-A** a **SERVER-B** y comprobamos que haya conexi√≥n entre ellas.

![ping de B a A](Imagenes/ping-10_20_0_10.png)

Si todo ha ido bien, vamos a intentar conectarnos por SSH desde la terminal anfitriona (no deber√≠a de dejar conectarnos). Al haber puesto `ssh sysadmin@10.20.0.20` y esperar un tiempo, sale este mensaje:

```
ssh: connect to host 10.20.0.20 port 22: Connection timed out
```

Eso significa que vamos por buen camino.

Ahora configuraremos **SERVER-C**.

### üì¶ SERVER-C
Ponemos `sudo nano /etc/netplan/50-cloud-init.yaml` y ponemos el adaptador y la **IP** de la tabla que viene m√°s arriba anotada.

![ip a SERVER-C](Imagenes/netplan-C.png)

Guardamos con `sudo netplan apply` y comprobamos con `ip a`.

![ip a SERVER-B](Imagenes/ipa-C.png)

Ahora con la red configurada de **SERVER-C**, vamos a hacer `ping 10.30.0.10` que es el adaptador por el que est√° conectado **SERVER-A** a **SERVER-C** y comprobamos que haya conexi√≥n entre ellas.

![ping C a A](Imagenes/ping-10_30_0_10.png)

Si da `ping`, vamos a intentar conectarnos por **SSH** desde la terminal anfitriona (deber√≠a de pasar igual que en SERVER-B). Al haber puesto `ssh sysadmin@10.30.0.20` y esperar un tiempo, sale este mensaje:

```
ssh: connect to host 10.30.0.20 port 22: Connection timed out
```
Como igual que en **SERVER-B**, son buenas noticias y ya tenemos toda la red configurada.

## üîë Creaci√≥n y configuraci√≥n de claves **SSH**
Ahora crearemos las claves **SSH** para conectarnos sin la contrase√±a. Lo haremos conectados por **SSH** desde la terminal anfitriona a **SERVER-A, B y C** y lo configuraremos todo desde ah√≠.

### üîó M√°quina anfitriona
Creamos la clave desde nuestra m√°quina anfitriona con `ssh-keygen`.

![Crear clave SSH](Imagenes/CrearClave.png)

Ahora, usamos `scp` y copiamos la clave que acabamos de generar de √©sta manera:
```
scp .\.ssh\id_ed25519.pub hector@192.168.56.10:~
```
![Copiar Clave a SERVER-A](Imagenes/CopiarClaveA.png)

Nos conectamos por **SSH** a **SERVER-A** y movemos la clave p√∫blica que acabamos de pasar hacia el directorio `.ssh/authorized_keys`.

```
cat id_25519.pub >> .ssh/authorized_keys
```

![Pasar clave a SERVER-A](Imagenes/PasarClave.png)

Para comprobarlo, salimos y volvemos a entrar por **SSH**, y no nos pedir√° la contrase√±a.

![Conectarse sin la contrase√±a a SERVER-A](Imagenes/ConectarNoContraA.png)

Podemos ver que todo ha ido bien.

### üîó SERVER-A
Ahora dentro de **SERVER-A**, generamos otra clave pero pondremos √©sta vez `ssh-keygen -b 1024`. Y luego lo comprobamos con `ls`.

![Crear clave en SERVER-A](Imagenes/CrearClaveA.png)

Genera dos claves al igual que en la anfitriona, una p√∫blica y la otra privada. La diferencia entre las dos, es que la p√∫blica tiene la extensi√≥n **.pub**.

Ahora copiamos la clave que hemos generado hacia **SERVER-B** y **SERVER-C**, igual que en los pasos anteriores.

```
scp .\.ssh\id_ed25519.pub sysadmin@10.20.0.20:~ (SERVER-B)
scp .\.ssh\id_ed25519.pub sysadmin@10.30.0.20:~ (SERVER-C)
```

![Pasar clave de A a B y C](Imagenes/PasarClaveA.png)

### üîó SERVER-B
Ahora entramos a **SERVER-B** desde **SERVER-A** y pasamos la clave a **authorized_keys**, igual que antes tambi√©n.

```
cat id_25519.pub >> .ssh/authorized_keys
```

![Pasar clave de A a B](Imagenes/PasarClaveB.png)

Salimos y volvemos a entrar por **SSH** y veremos que no nos pedir√° la contrase√±a igual que cuando hicimos desde la anfitriona a SERVER-A.

![Conectarse sin la contrase√±a desde A a B](Imagenes/ConectarNoContraB.png)

Al igual que antes, si no pide la contrase√±a, es que lo hemos hecho bien.

### üîó SERVER-C
Ahora entramos en **SERVER-C** y repetimos los mismos pasos.

```
cat id_25519.pub >> .ssh/authorized_keys
```

![Pasar clave de A a C](Imagenes/PasarClaveC.png)

Salimos y volvemos a entrar por **SSH** y veremos que tampoco pide la contrase√±a.

![Conectarse sin la contrase√±a desde A a C](Imagenes/ConectarNoContraC.png)

Y como antes, no pide la contrase√±a, todo correcto.

---
### [‚¨ÖÔ∏è Volver a UT02](../index.md)
---