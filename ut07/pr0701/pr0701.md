# üìÑ PR0701: Compartici√≥n de carpetas con Samba

## üìå Objetivo
1. Compartir 4 carpetas:
   - Gerencia, Administraci√≥n, Taller, P√∫blica
2. La empresa tendr√° 6 empleados:
   - ger01, adm01, adm02, tall01, tall02, tall03

Las carpetas ser√°n accesibles por los siguientes usuarios seg√∫n los siguientes criterios:
- Todos los empleados podr√°n acceder a la carpeta `P√∫blica` con permisos de lectura, mientras que el empleado `ger01` podr√° hacerlo con permisos de lectura y escritura.
- El empleado `ger01` podr√° acceder con todos los permisos a la carpeta `Gerencia`.
- Los empleados `adm01` y `adm02` tendr√°n acceso con todos los permisos a `Administraci√≥n` y con permisos de lectura √∫nicamente a la carpeta `Taller`.
- Los usuarios `tall01`, `tall02` y `tall03` tendr√°n acceso de lectura y escritura a la carpeta `Taller`.
- Cualquier usuario que no sea uno de los anteriores (invitado) podr√° acceder √∫nicamente a la carpeta `P√∫blica`.
- Los usuarios `ger01`, `adm01` y `adm02` usan **Windows**.
- Los usuarios `tall01`, `tall02` y `tall03` usan **Linux**.

## üìå Configuraci√≥n del entorno
Para la pr√°ctica prepararemos 3 m√°quinas virtuales, un **Ubuntu Server 20.04**, un **Ubuntu Desktop 20.04** y un **Windows 10** con la siguiente configuraci√≥n:

| Host                 | IP           | M√°scara de subred | Puerta de enlace | Servidor DNS     |
| -------------------- | ------------ | ----------------- | ---------------- | ---------------- |
| `smb-hbf`            | 192.168.1.10 | 255.255.255.0 /24 | 192.168.1.1      | 8.8.8.8, 8.8.4.4 |
| `ClienteUbuntu-HBF`  | 192.168.1.20 | 255.255.255.0 /24 | 192.168.1.1      | 8.8.8.8, 8.8.4.4 |
| `ClienteWindows-HBF` | 192.168.1.30 | 255.255.255.0 /24 | 192.168.1.1      | 8.8.8.8, 8.8.4.4 |

Ahora pondremos las IPs est√°ticas en cada m√°quina virtual, en mi caso, he puesto en cada una de ellas dos adaptadores de red, uno en **red interna** y el otro en **NAT**. As√≠ que configuramos la **red interna**.

### smb-hbf
Como en este caso es un Ubuntu Server, no tendremos entorno gr√°fico. Por lo que tendremos que editar el fichero de configuraci√≥n de red con el siguiente comando:
```bash
sudo nano /etc/netplan/00-installer-config.yaml
```

Pondremos lo siguiente:

![Config. red server](Imagenes/ipconfigS.png)

Aplicamos los cambios con `sudo netplan apply`. Para ver la IP pondremos `ifconfig`. Pero antes instalamos las `net-tools` con `sudo apt install net-tools`.

![ipS](Imagenes/ipS.png)

### ClienteUbuntu-HBF
Aqu√≠, tendremos un Ubuntu con entorno gr√°fico, por lo que podremos evitar el archivo de configuraci√≥n. Vamos a **Configuraci√≥n** e iremos al apartado de **Red**. Clicamos en la **ruleta** para configurar que en este caso es el primer adaptador de red `enp0s3`. Cuando estemos dentro, haremos lo siguiente:

![Config. red ubuntu](Imagenes/ipconfigL.png)

Veremos la IP con el comando `ifconfig`.

![ipL](Imagenes/ipL.png)

### ClienteWindows-HBF
Para Windows, pulsamos la combinaci√≥n de teclas `Win+X` y escribimos `ncpa.cpl`, hacemos clic derecho en el adaptador de red y clicamos en `Propiedades`. Luego, clicamos en `Protocolo de Internet versi√≥n 4 (TCP/IPv4)` y pondremos lo siguiente:

![Config. red windows](Imagenes/ipconfigW.png)

Miramos la IP con el comando `ipconfig /all`.

![ipW](Imagenes/ipW.png)

Por √∫ltimo, desactivamos el **Firewall** desde el **Panel de control**, yendo hacia `Sistema y seguridad ‚Üí Firewall de Windows Defender` y en la parte de la izquierda, clicamos en `Activar o desactivar el Firewall de Windows Defender`. Clicamos en `Desactivar Firewall de Windows Defender` tanto en `Redes privadas` como en `Redes p√∫blicas o invitadas`, aceptamos y ya est√° desactivado el Firewall.

![Firewall](Imagenes/Firewall.png)

## üìå Instalaci√≥n y configuraci√≥n de `Samba`
Vamos a nuestro servidor y pondremos estos comandos:
```bash
sudo apt update
sudo apt install samba smbclient
```

Cuando lo tengamos instalado, pondremos este comando para verificar la versi√≥n que tenemos:
```bash
smbd --version
```

En mi caso tengo la versi√≥n `Version 4.15.13-Ubuntu`.

### Creaci√≥n de los grupos y usuarios
Para crear los grupos, lo hacemos con el comando `groupadd`.
```bash
sudo groupadd gerencia
sudo groupadd administracion
sudo groupadd taller
```

Para los usuarios, los creamos con el comando `useradd`. Pondremos los modificadores `-m` y `-G`.
```bash
sudo useradd -m -G gerencia ger01
sudo useradd -m -G administracion adm01
sudo useradd -m -G administracion adm02
sudo useradd -m -G taller tall01
sudo useradd -m -G taller tall02
sudo useradd -m -G taller tall03
```

Ahora les pondremos la contrase√±a a cada usuario que hemos creado. Usaremos el comando `smbpasswd`, nos pedir√° que repitamos la contrase√±a en cada uno de los casos. Le pondremos el modificador `-a`.
```bash
sudo smbpasswd -a ger01
sudo smbpasswd -a adm01
sudo smbpasswd -a adm02
sudo smbpasswd -a tall01
sudo smbpasswd -a tall02
sudo smbpasswd -a tall03
```

Para hacer la verificaci√≥n entre los usuarios de **Linux** y **Samba**, pondremos este comando:
```bash
sudo pdbedit -L
```

![Verificar usuarios](Imagenes/verificarUsuarios.png)

### Creaci√≥n de las carpetas compartidas
Creamos las carpetas compartidas para los diferentes usuarios en un directorio que se llama `/samba`, de froma que sea f√°cil de buscar. Creamos uno por cada usuario usando el comando `mkdir`.
```bash
sudo mkdir /samba
sudo mkdir /samba/Gerencia
sudo mkdir /samba/Administracion
sudo mkdir /samba/Taller
sudo mkdir /samba/Publica
```

### Permisos y propietarios
Vamos a gestionar los permisos de cada una de las carpetas que hemos creado, d√°ndoles permiso al grupo. Tendremos que hacer uso del comando `chmod` y `chown`.

- Carpeta Gerencia

```bash
sudo chown root:gerencia /samba/Gerencia
sudo chmod 2775 /samba/Gerencia
```

- Carpeta Administracion

```bash
sudo chown root:administracion /samba/Administracion
sudo chmod 2775 /samba/Administracion
```

- Carpeta Taller

```bash
sudo chown root:taller /samba/Taller
sudo chmod 2775 /samba/Taller
```

- Carpeta Publica

```bash
sudo chown root:root /samba/Publica
sudo chmod 755 /samba/Publica
```

### Configuraci√≥n del fichero `smb.conf`
Antes de modificar el fichero, haremos una copia de seguridad del mismo. Usamos el comando `cp`.
```bash
sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.bak
```

Cuando ya lo tengamos copiado, modificamos el archivo con `sudo nano /etc/samba/smb.conf` y pondremos lo siguiente:
```bash
[Publica]
comment = Carpeta Publica
path = /samba/Publica
browsable = yes
guest ok = yes
read only = yes
write list = ger01
create mask = 0644
directory mask = 0755

[Gerencia]
comment = Carpeta Gerencia
path = /samba/Gerencia
browsable = yes
valid users = @gerencia
read only = no

[Administracion]
comment = Carpeta Administracion
path = /samba/Administracion
browsable = yes
valid users = @administracion
read only = no

[Taller]
comment = Carpeta Taller
path = /samba/Taller
browsable = yes
valid users = @taller adm01 adm02
read only = no
write list = @taller
```

Dentro de `[global]`, pondremos esto en cualquier sitio:

![global](Imagenes/global.png)

### Reinicio del servicio
Reiniciamos el servicio poniendo estos dos comandos:
```bash
sudo systemctl restart smbd
sudo systemctl status smbd
```

![status](Imagenes/status.png)

## üìå Acceso desde Windows
Entramos en Configuraci√≥n con Ctrl+I, vamos a **Cuentas ‚Üí Otros usuarios** y creamos a los usuarios `ger01`, `adm01` y `adm02`.

![usuarios](Imagenes/usuariosW.png)

### Comprobaci√≥n de `Gerencia`
Iniciamos sesi√≥n con `ger01`. Abrimos el explorador de archivos y escribimos `\\192.168.1.10`. Con esto entrar√≠amos a las carpetas de **Samba**, clicamos en Gerencia y creamos un archivo de texto. Si nos permite hacerlo, est√° bien configurado.

![Gerencia](Imagenes/gerencia.png)

### Comprobaci√≥n de `Administracion`
Iniciamos sesi√≥n con `adm01`. Haciendo lo mismo entramos ahora en Administracion y creamos un archivo de texto. Si podemos, est√° bien configurado.

![Administracion](Imagenes/administracion.png)

Si intentamos entrar ahora en **Taller**, veremos que no podemos modificar, solo ver.

![Administracion1](Imagenes/administracion1.png)

Si intentamos entrar con un usuario a una carpeta sin permisos, nos saldr√° el siguiente aviso:

![Aviso](Imagenes/aviso.png)

> üí¨ He intentado entrar con el usuario `adm01` hacia **Gerencia**.

### Comprobaci√≥n de `Publica`
Si volvemos hacia `\\192.168.1.10` e intentamos entrar en **Publica**, veremos que nos dar√° error.

![Carpetas](Imagenes/carpetas.png)

![Error](Imagenes/error.png)

## üìå Acceso desde Linux
Creamos a los usuarios de Taller:
```bash
sudo adduser tall01
sudo adduser tall02
sudo adduser tall03
```

Instalamos lo siguiente:
```bash
sudo apt install smbclient
sudo apt install cifs-utils
```

### Comprobaci√≥n de `Taller`
Comprobamos el acceso con el siguiente comando:
```bash
smbclient //192.168.1.10/Taller -U tall01
```

![Taller](Imagenes/taller.png)

Saldremos de ah√≠ con Ctrl+C y montamos la carpeta compartida con lo siguiente:
```bash
sudo mkdir -p /mnt/Taller
sudo mount -t cifs //192.168.1.10/Taller /mnt/Taller -o user=tall01
```

![Carpeta compartida](Imagenes/carpetaCompartida.png)

Probamos la lectura y escritura:
```bash
cd /mnt/Taller
touch prueba.txt
```

![Prueba Taller](Imagenes/archivoTaller.png)

### Comprobaci√≥n de `Publica`
Creamos la carpeta y la montamos:
```bash
sudo mkdir /mnt/Publica
sudo mount -t cifs //192.168.1.10/Publica /mnt/Publica -o guest,uid=tall01
```

Comprobamos que podremos leer pero no escribir.
```bash
ls /mnt/Publica/
touch /mnt/Publica/prueba.txt
```

![Prueba Publica](Imagenes/pruebaPublicaL.png)

---
### [‚¨ÖÔ∏è Volver a UT07](../index.md)
---