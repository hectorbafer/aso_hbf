# 游늯 PR0605: Limpieza de logs
## 游늷 1. Objetivo
Eres el administrador de sistemas y debes crear un script en PowerShell que convierta unos logs antiguos y mal formateados en un archivo CSV limpio y estructurado para que el departamento de seguridad pueda auditar los accesos, ya que no es posible modificar c칩mo el servidor genera dichos logs.

## 游늷 2. Datos de entrada
Copiamos y pegamos el texto del ejercicio:
```powershell
$logCrudo = @"
[INFO] ID:8842 :: 2023/11/01_10:00 :: User:admin_01 :: Action:Login_Success
[ERROR] ID:9921 :: 2023/11/01_10:05 :: User:guest_user :: Action:Auth_Fail (Pass)
[WARN] ID:8843 :: 2023-11-01 10:15 :: User:dev_team :: Action:Upload_Limit_Exceeded
[CRITICAL] ID:1001 :: 01-11-2023_10:20 :: User:ROOT :: Action:Service_Stop
"@

$lineas = $logCrudo -split "`n"
$resultado = @()
```

## 游늷 3. Los requisitos
> 游눫 El c칩digo se ha separado por los apartados que se pide, pero m치s abajo est치 todo junto para copiar y pegar de una sola vez.

### Apartado 1
```powershell
foreach ($linea in $lineas) {
    $fechaTexto = ($linea -split "::")[1].Trim()
    $fechaTexto = $fechaTexto -replace "_", " "
    $fechaTexto = $fechaTexto -replace "/", "-"
    $timestamp = Get-Date $fechaTexto -Format "yyyy-MM-dd HH:mm"
```

### Apartado 2
```powershell
    $user = ($linea -split "User:")[1] -split "::"
    $user = $user[0].Trim().ToLower()

    if ($user -eq "root") {
        $user = "administrator"
    }
```

### Apartado 3
```powershell
    $severity = ($linea -split "\]")[0] -replace "\[", ""
```

### apartado 4
```powershell
    if ($linea -like "[INFO]*") {
        continue
    }
```

### Apartado 5
```powershell
    $eventID = ($linea -split "ID:")[1] -split "::"
    $eventID = $eventID[0].Trim()

    $action = ($linea -split "Action:")[1].Trim()

    $objeto = [PSCustomObject]@{
        TimeStamp = $timestamp
        Severity  = $severity
        User      = $user
        EventID   = $eventID
        Action    = $action
    }

    $resultado += $objeto
}
```

## 游닍 C칩digo completo para copiar y pegar
```powershell
$logCrudo = @"
[INFO] ID:8842 :: 2023/11/01_10:00 :: User:admin_01 :: Action:Login_Success
[ERROR] ID:9921 :: 2023/11/01_10:05 :: User:guest_user :: Action:Auth_Fail (Pass)
[WARN] ID:8843 :: 2023-11-01 10:15 :: User:dev_team :: Action:Upload_Limit_Exceeded
[CRITICAL] ID:1001 :: 01-11-2023_10:20 :: User:ROOT :: Action:Service_Stop
"@

$lineas = $logCrudo -split "`n"
$resultado = @()

foreach ($linea in $lineas) {

    if ($linea -like "[INFO]*") {
        continue
    }

    $severity = ($linea -split "\]")[0] -replace "\[", ""

    $eventID = ($linea -split "ID:")[1] -split "::"

    $eventID = $eventID[0].Trim()

    $fechaTexto = ($linea -split "::")[1].Trim()

    $fechaTexto = $fechaTexto -replace "_", " "

    $fechaTexto = $fechaTexto -replace "/", "-"

    $timestamp = Get-Date $fechaTexto -Format "yyyy-MM-dd HH:mm"

    $user = ($linea -split "User:")[1] -split "::"
    $user = $user[0].Trim().ToLower()

    if ($user -eq "root") {
        $user = "administrator"
    }

    $action = ($linea -split "Action:")[1].Trim()

    $objeto = [PSCustomObject]@{
        TimeStamp = $timestamp
        Severity  = $severity
        User      = $user
        EventID   = $eventID
        Action    = $action
    }

    $resultado += $objeto
}
```

## 游늷 4. Resultado esperado
```powershell
$resultado | Export-Csv "reporte_seguridad.csv" -NoTypeInformation -Encoding UTF8
```

Para ver el resultado desde Powershell pondremos el siguiente comando:
```powershell
Import-Csv "reporte_seguridad.csv" | Format-Table
```

![Resultado final](Imagenes/Resultado.png)

---
### [拘勇 Volver a UT06](../index.md)
---