# üìÑ PR0401: Administraci√≥n remota en Windows

## üìå 1. Entorno virtualizado y preparaci√≥n de las m√°quinas
Para hacer la pr√°ctica, necesitaremos las siguientes m√°quinas en **VirtualBox** con este hostname:
- Windows Server 2019 con experiencia de escritorio  (o GUI): **HBF-2019**
- Windows Server 2019 en modo Core: **HBF-CORE-2019**
- Windows Server 2016 en modo Core: **HBF-CORE-2016**

Todas las m√°quinas tienen solamente un adaptador de red en **puente** para tener acceso a Internet y no requerir de un adaptador secundario. Todo se realizar√° desde **Powershell**, en el que en la versi√≥n **GUI** lo ejecutamos como Administrador y en la versi√≥n **CORE** solo basta con poner `powershell`.

Para cambiar el nombre de la m√°quina tanto en la versi√≥n **GUI** como la **CORE**, podemos usar el mismo comando que es el siguiente:
```powershell
Rename-Computer -NewName <nuevo nombre> -Restart
```

> üí¨ Se nos reiniciar√°n las m√°quinas al instante por haberle puesto `-Restart`.

Ahora, tendremos que a√±adirles una IP est√°tica. Esta va a ser una tabla de qu√© IPs van a tener las m√°quinas:

| Host          | IP           | M√°scara de subred | Puerta de enlace | Servidor DNS |
| ------------- | ------------ | ----------------- | ---------------- | ------------ |
| HBF-2019      | 192.168.1.10 | 255.255.255.0 /24 | 192.168.1.1      | 8.8.8.8      |
| HBF-CORE-2019 | 192.168.1.20 | 255.255.255.0 /24 | 192.168.1.1      | 8.8.8.8      |
| HBF-CORE-2016 | 192.168.1.30 | 255.255.255.0 /24 | 192.168.1.1      | 8.8.8.8      |

> üí¨ El DNS es opcional pero me apetec√≠a ponerlo.

### Versi√≥n GUI
Podemos cambiar la **IP** haciendo la combinaci√≥n de teclas `Win+R` y escribimos `ncpa.cpl`, con esto nos ahorramos algo de tiempo y es m√°s directo.  
Ahora, hacemos clic derecho en el adaptador de red y clicamos en `Propiedades`. Luego, clicamos en `Protocolo de Internet versi√≥n 4 (TCP/IPv4)`. Lo dejamos tal cual est√° en la captura.

![ip ws2019](Imagenes/IPestatica.png)

Podemos comprobarlo abriendo la terminal y escribiendo `ipconfig /all`.

![ipconfig2019](Imagenes/ipconfig.png)

Editamos el archivo `hosts` que se encuentra en `C:\Windows\System32\drivers\etc\hosts` para habilitar la resoluci√≥n local de nombres entre las dem√°s m√°quinas. Lo editamos con el **bloc de notas** pondremos lo siguiente al final del documento:
```
192.168.1.10 HBF-2019
192.168.1.20 HBF-CORE-2019
192.168.1.30 HBF-CORE-2016
```

Por √∫ltimo, desactivamos el Firewall desde el **Panel de control** yendo hacia `Sistema y seguridad ‚Üí Firewall de Windows Defender` y en la parte de la izquierda, clicamos en `Activar o desactivar el Firewall de Windows Defender`. Clicamos en `Desactivar Firewall de Windows Defender` tanto en `Redes privadas` como en `Redes p√∫blicas o invitadas`, aceptamos y ya est√° desactivado el Firewall.

![Firewall](Imagenes/Firewall.png)

### Versi√≥n CORE
Para cambiar la IP, tenemos que poner el comando `New-NetIPAddress` y `Set-DnsClientServerAddress` para poner un servidor DNS. Pondremos lo siguiente con `Powershell`:

- **HBF-CORE-2019**

```powershell
New-NetIPAddress `
 -InterfaceAlias "Ethernet" `
 -IPAddress 192.168.1.20 `
 -PrefixLength 24 `
 -DefaultGateway 192.168.1.1

Set-DnsClientServerAddress `
 -InterfaceAlias "Ethernet" `
 -ServerAddresses 8.8.8.8
```

Comprobamos la configuraci√≥n poniendo el comando `Get-NetIPconfiguration`.

![IPconfiguration2019](Imagenes/IPconfiguration2019.png)

- **HBF-CORE-2016**

```powershell
New-NetIPAddress `
 -InterfaceAlias "Ethernet" `
 -IPAddress 192.168.1.30 `
 -PrefixLength 24 `
 -DefaultGateway 192.168.1.1

Set-DnsClientServerAddress `
 -InterfaceAlias "Ethernet" `
 -ServerAddresses 8.8.8.8
```

Comprobamos la configuraci√≥n poniendo el comando `Get-NetIPconfiguration`.

![IPconfiguration2016](Imagenes/IPconfiguration2016.png)

Para editar el archivo `hosts` en **CORE**, pondremos el comando `notepad C:\Windows\System32\drivers\etc\hosts`, se nos abrir√° el **Bloc de notas** y lo dejaremos exactamente igual que en la versi√≥n **GUI**, es decir, al final del documento pondremos esto:
```
192.168.1.10 HBF-2019
192.168.1.20 HBF-CORE-2019
192.168.1.30 HBF-CORE-2016
```

Para desactivar el **Firewall** en ambas m√°quinas, pondremos lo siguiente:
```powershell
Set-NetFirewallProfile `
-Profile Domain,Public,Private `
-Enabled False

Get-NetFirewallProfile | Select-Object Name, Enabled
```
- **HBF-CORE-2019**

![Firewall2019](Imagenes/Firewall2019.png)

- **HBF-CORE-2016**

![Firewall2016](Imagenes/Firewall2016.png)

### Comprobaci√≥n con `ping`
Para acabar con la configuraci√≥n inicial, comprobamos que se hagan ping entre ellas, he puesto el comando `ping` + el nombre del **Host** de las m√°quinas para que aparezcan tanto el nombre y la IP que tienen.

- **HBF-2019**

![ping](Imagenes/ping.png)

- **HBF-CORE-2019**

![ping2019](Imagenes/ping2019.png)

- **HBF-CORE-2016**

![ping2016](Imagenes/ping2016.png)

## üìå 2. Configuraci√≥n del acceso remoto al nuevo equipo
### Lista TrustedHosts
En nuestra m√°quina cliente, que va a ser la versi√≥n **GUI**, a√±adimos los servidores a la lista **TrustedHosts**. Esto permite conectarnos a los servidores. Ponemos los siguientes comandos:
```powershell
set-Item WSMan:\localhost\CLient\TrustedHosts -Value "192.168.1.20, 192.168.1.30"
  # Tecleamos "S" para aceptar
winrm get winrm/config/client
```

![TrustedHosts2019](Imagenes/TrustedHosts19.png)

Ahora haremos lo mismo para los **servidores**, pero antes, tenemos que ejecutar este comando en ambas m√°quinas para habilitar el acceso remoto:
```powershell
Enable-PSRemoting -Force
```

Ahora, procedemos a poner **TrustedHosts** en los servidores.

- **HBF-CORE-2019**

```powershell
set-Item WSMan:\localhost\CLient\TrustedHosts -Value "192.168.1.10, 192.168.1.30"
  # Tecleamos "S" para aceptar
winrm get winrm/config/client
```

![TrustedHosts19](Imagenes/TrustedHosts2019.png)

- **HBF-CORE-2016**

```powershell
set-Item WSMan:\localhost\CLient\TrustedHosts -Value "192.168.1.10, 192.168.1.20"
  # Tecleamos "S" para aceptar
winrm get winrm/config/client
```

![TrustedHosts16](Imagenes/TrustedHosts2016.png)

### Acceso remoto
Para poder tener todos los permisos para acceder por remoto, tenemos que poner el siguiente comando en los dos servidores:
```powershell
New-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name LocalAccountTokenFilterPolicy -Value 1 -Force
```

Ahora podemos ejecutar comandos de nuestra m√°quina cliente hacia los servidores. El ejercicio pide que hagamos un usuario que sea `admin-hbf`. Para ello, pondremos el siguiente comando:
```powershell
Invoke-Command -ComputerName 192.168.1.20 -Credential $cred -ScriptBlock {
New-LocalUser -Name "admin-hbf"
Add-LocalGroupMember -Group "Administrators" -Member "admin-hbf"
}
```

Nos pedir√°n las credendiales de la m√°quina servidor, tendremos que poner la **IP** con el **usuario** y la **contrase√±a**.

![Credenciales2019](Imagenes/credenciales2019.png)

Tendremos que volver a repetir la contrase√±a y veremos que s√≠ ha creado al usuario.

![UsuarioRemoto2019](Imagenes/UsuarioRemoto2019.png)

Repetimos lo mismo pero para el servidor **HBF-CORE-2016**.

![Credenciales2016](Imagenes/credenciales2016.png)

![UsuarioRemoto2016](Imagenes/UsuarioRemoto2016.png)

## üìå 3. Configuraci√≥n del acceso remoto sobre HTTPS
### Crear Certificado Autofirmado
Para conseguir que sea `HTTPS`, es necesario que tengamos un certificado. Al no conseguir uno de terceros, creamos uno que sea autofirmado. Vamos a una m√°quina servidor, que en mi caso usar√© `HBF-CORE-2016` porque le he instalado las **GuestAddition** y es mejor para copiar y pegar. Ponemos el siguiente comando:
```powershell
New-SelfSignedCertificate `
 -DnsName "HBF-CORE-2016" `
 -CertStoreLocation Cert:\LocalMachine\My `
 -KeyLength 2048
```

![Certificado2016](Imagenes/certificado2016.png)

### Listeners
Tenemos que eliminar el Listener actual para crear uno nuevo para el certificado. Para ello ponemos lo siguiente:
```powershell
Remove-Item -Path WSMan:\localhost\Listener\Listener* -Recurse
```

Volvemos a crearlo con las especificaciones que vayamos a necesitar con el siguiente comando:
```powershell
New-Item -Path WSMan:\localhost\Listener -Transport HTTPS -Address * -CertificateThumbPrint <hash del certificado>
  # Tecleamos "S" para aceptar
```

![Nuevo Listener](Imagenes/NuevoListener.png)

### Crear reglas de Firewall
Creamos una regla de Firewall para permitir acceso por el puerto necesario con el siguiente comando:
```powershell
netsh advfirewall firewall add rule name="WinRM HTTPS" protocol=TCP dir=in localport=5986 action=allow
```

![Regla Firewall](Imagenes/ReglaFirewall.png)

### Exportaci√≥n del certificado
Exportamos el certificado que hemos creado en la ruta que hemos especificado con el siguiente comando:
```powershell
Export-Certificate -Cert Cert:\LocalMachine\My\<hash del certificado> -FilePath C:\servercert.cer
```

![Exportar certificado](Imagenes/ExportarCertificado.png)

### Uso de carpetas compartidas
Vamos a tener que crear una carpeta compartida en nuestro cliente para que sea accesible pasar el certificado del servidor al cliente.

Creamos una carpeta en `C:` con el nombre de `Compartir`.  
Vamos a `Propiedades ‚Üí Compartir ‚Üí Uso compartido avanzado`.

![Compartir carpeta](Imagenes/CompartirCarpeta.png)

Marcamos la opci√≥n de Compartir esta carpeta y pondremos el nombre de la carpeta.

![Compartir avanzado](Imagenes/CompartirAvanzado.png)

Clicamos en `Permisos` y en el grupo de **Todos**, le damos `Control Total`.

![Control total](Imagenes/ControlTotal.png)

Para que sea m√°s seguro, volvemos a Propiedades y vamos a Seguridad. A√±adimos al grupo Todos y le damos Control Total

![Seguridad Todos](Imagenes/SeguridadTodos.png)

### Copia del certificado
Copiamos el certificado en la carpeta compartida con el siguiente comando:
```powershell
Copy-Item -Path C:\servercert.cer -Destination "\\<ip del cliente\carpeta>"
```

> üí¨ Me daba error el comando y no he encontrado una soluci√≥n para ello, pongo una captura del error.
>
> ![Error](Imagenes/Error.png)

El siguiente paso es comprobar el certificado en la carpeta desde el cliente. Pondremos lo siguiente:
```powershell
cd C:\Compartir\

dir
  # Veremos que tiene el certificado
```

### Importar certificado y acceso remoto por `HTTPS`
Desde el cliente importamos el certificado con el siguiente comando:
```powershell
Import-Certificate -FilePath C:\Compartir\servercert.cer -CertStoreLocation Cert:\LocalMachine\Root
```

Para verlo mejor, con la combinaci√≥n de teclas de `Win+R` ponemos `certmgr.msc` y veremos el certificado con el nombre del **Host** del servidor.

Probamos a conectarnos desde el cliente hacia el servidor con el siguiente comando:
```powershell
Enter-PSSession -ComputerName HBF-CORE-2016 -Credential Administrador -UseSSL
```

> üí¨ Esto tampoco puedo probarlo porque necesitar√≠a el certificado s√≠ o s√≠.

Hacemos lo mismo pero ahora para el servidor HBF-CORE-2019.

![Certificado 2019](Imagenes/certificado2019.png)

> üí¨ Tambi√©n me ha dado error. No puedo terminar de comprobarlo.
>
> ![Error2](Imagenes/Error2.png)

## üìå 4. Configuraci√≥n remota con Windows Admin Center
Descargamos **Windows Admin Center** del enlace https://www.microsoft.com/es-es/windows-server/windows-admin-center. Cuando lo tengamos descargado, procedemos a realizar exactamente los siguientes pasos de la instalaci√≥n:

![WAC1](Imagenes/WAC1.png)

![WAC2](Imagenes/WAC2.png)

![WAC3](Imagenes/WAC3.png)

![WAC4](Imagenes/WAC4.png)

![WAC5](Imagenes/WAC5.png)

![WAC6](Imagenes/WAC6.png)

![WAC7](Imagenes/WAC7.png)

En el √∫ltimo paso, lo que nos sale es un resumen de lo que va a hacer **Windows Admin Center**, podemos ver que el puerto que va a usar es el `443`.

El siguiente paso es quitar la `Configuraci√≥n mejorada de Internet Explorer`. Desde el **Administrador del servidor**, clicamos en **Servidor local** y vemos que en **Propiedades**, la configuraci√≥n de **IE** est√° activado, esto significa que en cada p√°gina que entremos desde Internet Explorer nos la bloquea.

![IE activado](Imagenes/IEactivado.png)

Para desactivarlo, clicamos en **Activado** y seleccionamos lo siguiente:

![Desactivar IE](Imagenes/IEseguridad.png)

Luego, reiniciamos la m√°quina para que se apliquen los cambios. Si volvemos, veremos que pone **Desactivado**, ahora ya no nos bloquear√° ninguna p√°gina.

![IE desactivado](Imagenes/IEdesactivado.png)

Cuando hayamos reiniciado la m√°quina, accedemos al enlace de `https://hbf-2019/` y veremos el mensaje de que esa p√°gina no es segura. Clicamos en `M√°s informaci√≥n` y luego a `Continuar en la p√°gina web (no recomendado)`.

![Sitio no seguro](Imagenes/noseguro.png)

Ahora nos aparecer√° la siguiente p√°gina:

![WAC](Imagenes/PaginaWAC.png)

Ya tenemos instalado Windows Admin Center, lo malo es que ya no tiene soporte para Internet Explorer, con lo que no nos dejar√° iniciar sesi√≥n. Hay dos opciones por las que se puede resolver esto:
1. Descargar otro navegador.
2. Acceder por remoto desde otra m√°quina.

Para esta pr√°ctica, hay que hacer el paso 2.

Desde un Windows 10, a√±adimos en el fichero hosts los servidores, es decir, pondremos esto al final:
```
192.168.1.20 HBF-CORE-2019
192.168.1.30 HBF-CORE-2016
```

Guardamos el archivo. Ahora tendr√≠amos que acceder desde el navegador poniendo `https://"ip-servidor"`.

> üí¨ Como no he conseguido hacer los certificados en el ejercicio anterior, no puedo acceder. Pero con esto ya podr√≠amos conectarnos por remoto hacia **Windows Admin Center**.
>
> ![Error3](Imagenes/Error3.png)

---
### [‚¨ÖÔ∏è Volver a UT04](../index.md)
---